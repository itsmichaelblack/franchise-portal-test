rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ────────────────────────────────────────────────────

    // Check if the requesting user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Get the requesting user's profile document from Firestore
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Role checks for HQ staff
    function isMasterAdmin() {
      return isAuth() && userDoc().role == 'master_admin';
    }

    function isAdmin() {
      return isAuth() && (userDoc().role == 'admin' || userDoc().role == 'master_admin');
    }

    // Check if the user is a franchise partner for a specific location
    function isFranchisePartner(locationId) {
      return isAuth() && userDoc().role == 'franchise_partner' && userDoc().locationId == locationId;
    }

    // ── Users collection ────────────────────────────────────────────────────
    // Stores role, name, locationId (for partners), etc.
    match /users/{userId} {
      // Users can read their own document
      allow read: if isAuth() && request.auth.uid == userId;

      // Master admins can read all user documents (for admin management)
      allow read: if isMasterAdmin();

      // Only master admins can create or update user roles
      allow create, update: if isMasterAdmin();

      // Nobody can delete user documents through the client (use Admin SDK only)
      allow delete: if false;
    }

    // ── Franchise Locations collection ──────────────────────────────────────
    match /locations/{locationId} {
      // HQ admins (both roles) can read all locations
      allow read: if isAdmin();

      // Franchise partners can read their own location
      allow read: if isFranchisePartner(locationId);

      // Both admin and master_admin can create and update locations
      allow create, update: if isAdmin()
        && request.resource.data.keys().hasAll(['name', 'address', 'phone', 'email', 'createdAt'])
        && request.resource.data.name is string
        && request.resource.data.email is string
        && request.resource.data.phone is string
        && request.resource.data.address is string;

      // Only master_admin can delete locations
      allow delete: if isMasterAdmin();
    }

    // ── Availability collection ─────────────────────────────────────────────
    // Each document ID matches a locationId
    match /availability/{locationId} {
      // HQ admins can read all availability
      allow read: if isAdmin();

      // Franchise partners can read and write their own availability
      allow read, write: if isFranchisePartner(locationId)
        && request.resource.data.keys().hasAll(['schedule', 'timezone', 'bufferMinutes'])
        && request.resource.data.bufferMinutes is int
        && request.resource.data.bufferMinutes >= 0
        && request.resource.data.bufferMinutes <= 120
        && request.resource.data.timezone is string;
    }

    // ── Bookings collection ──────────────────────────────────────────────
    match /bookings/{bookingId} {
      // Anyone can create a booking (public booking form)
      allow create: if true;

      // HQ admins can read all bookings
      allow read: if isAdmin();

      // Franchise partners can read bookings for their location
      allow read: if isAuth() && resource.data.locationId == userDoc().locationId;

      // Franchise partners can update bookings for their location
      allow update: if isAuth() && resource.data.locationId == userDoc().locationId;

      // HQ admins can update/delete any booking
      allow update, delete: if isAdmin();
    }

    // ── Settings collection ────────────────────────────────────────────────
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ── Services collection ────────────────────────────────────────────────
    match /services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ── Invites collection ────────────────────────────────────────────────
    // Stores pending HQ user invites
    match /invites/{inviteId} {
      // Master admins can read all invites
      allow read: if isMasterAdmin();

      // Master admins can create invites
      allow create: if isMasterAdmin();

      // Master admins can update invites (e.g. status changes)
      allow update: if isMasterAdmin();

      // Master admins can delete invites (e.g. revoking pending invites)
      allow delete: if isMasterAdmin();
    }

    // ── Activity Logs collection ────────────────────────────────────────────
    // Stores user activity logs per location (sign-ins, edits, etc.)
    // Also stores HQ-scoped logs (scope: 'hq') for admin actions across all locations.
    match /activity_logs/{logId} {
      // HQ admins can read all logs
      allow read: if isAdmin();

      // Master admins can read all logs (including HQ user logs)
      allow read: if isMasterAdmin();

      // Franchise partners can read logs for their location
      allow read: if isAuth() && resource.data.locationId == userDoc().locationId;

      // Authenticated users can create logs (logging their own actions)
      allow create: if isAuth();

      // Nobody can update or delete logs
      allow update, delete: if false;
    }

    // ── Deny everything else ────────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
