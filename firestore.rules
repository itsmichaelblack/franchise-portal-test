rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ────────────────────────────────────────────────────

    // Check if the requesting user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Get the requesting user's profile document from Firestore
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Role checks for HQ staff
    function isMasterAdmin() {
      return isAuth() && userDoc().role == 'master_admin';
    }

    function isAdmin() {
      return isAuth() && (userDoc().role == 'admin' || userDoc().role == 'master_admin');
    }

    // Check if the user is a franchise partner for a specific location
    function isFranchisePartner(locationId) {
      return isAuth() && userDoc().role == 'franchise_partner' && userDoc().locationId == locationId;
    }

    // ── Users collection ────────────────────────────────────────────────────
    // Stores role, name, locationId (for partners), etc.
    match /users/{userId} {
      // Users can read their own document
      allow read: if isAuth() && request.auth.uid == userId;

      // Master admins can read all user documents (for admin management)
      allow read: if isMasterAdmin();

      // Admins can read all user documents (for listing HQ users)
      allow read: if isAdmin();

      // Only master admins can create or update user roles
      allow create, update: if isMasterAdmin();

      // Allow franchise partners to self-register (create their own profile)
      // when they sign in for the first time
      allow create: if isAuth()
        && request.auth.uid == userId
        && request.resource.data.role == 'franchise_partner'
        && request.resource.data.email == request.auth.token.email;

      // Nobody can delete user documents through the client (use Admin SDK only)
      allow delete: if false;
    }

    // ── Franchise Locations collection ──────────────────────────────────────
    match /locations/{locationId} {
      // Public read access (needed for the Find a Centre page)
      allow read: if true;

      // Both admin and master_admin can create and update locations
      allow create, update: if isAdmin()
        && request.resource.data.keys().hasAll(['name', 'address', 'phone', 'email', 'createdAt'])
        && request.resource.data.name is string
        && request.resource.data.email is string
        && request.resource.data.phone is string
        && request.resource.data.address is string;

      // Only master_admin can delete locations
      allow delete: if isMasterAdmin();
    }

    // ── Availability collection ─────────────────────────────────────────────
    // Each document ID matches a locationId
    match /availability/{locationId} {
      // Public read access (needed for booking page)
      allow read: if true;

      // Franchise partners can write their own availability
      allow write: if isFranchisePartner(locationId)
        && request.resource.data.keys().hasAll(['schedule', 'timezone', 'bufferMinutes'])
        && request.resource.data.bufferMinutes is int
        && request.resource.data.bufferMinutes >= 0
        && request.resource.data.bufferMinutes <= 120
        && request.resource.data.timezone is string;

      // Admins can also write availability
      allow write: if isAdmin();
    }

    // ── Bookings collection ──────────────────────────────────────────────
    match /bookings/{bookingId} {
      // Anyone can create a booking (public booking form)
      allow create: if true
        && request.resource.data.keys().hasAll(['locationId', 'date', 'time', 'duration', 'customerName', 'customerEmail', 'customerPhone', 'status', 'createdAt'])
        && request.resource.data.status == 'confirmed'
        && request.resource.data.duration == 40;

      // Public can read bookings (needed to check available slots)
      allow read: if true;

      // HQ admins can update/delete bookings
      allow update, delete: if isAdmin();
    }

    // ── Deny everything else ────────────────────────────────────────────────
    // ── Settings collection ──────────────────────────────────────────────
    match /settings/{settingId} {
      // Public read (booking page needs youtube URL)
      allow read: if true;
      // Only admins can write settings
      allow write: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
