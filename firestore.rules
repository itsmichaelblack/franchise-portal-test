rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper functions ────────────────────────────────────────────────────

    // Check if the requesting user is authenticated
    function isAuth() {
      return request.auth != null;
    }

    // Get the requesting user's profile document from Firestore
    function userDoc() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Role checks for HQ staff
    function isMasterAdmin() {
      return isAuth() && userDoc().role == 'master_admin';
    }

    function isAdmin() {
      return isAuth() && (userDoc().role == 'admin' || userDoc().role == 'master_admin');
    }

    // Check if the user is a franchise partner for a specific location
    function isFranchisePartner(locationId) {
      return isAuth() && userDoc().role == 'franchise_partner' && userDoc().locationId == locationId;
    }

    // ── Users collection ────────────────────────────────────────────────────
    // Stores role, name, locationId (for partners), etc.
    match /users/{userId} {
      // Users can read their own document
      allow read: if isAuth() && request.auth.uid == userId;

      // Master admins can read all user documents (for admin management)
      allow read: if isMasterAdmin();

      // Only master admins can create or update user roles
      allow create, update: if isMasterAdmin();

      // Allow users to create their own profile during auto-registration
      // (franchise partner first sign-in creates their profile with role 'franchise_partner')
      allow create: if isAuth() && request.auth.uid == userId
        && request.resource.data.role == 'franchise_partner';

      // Allow HQ invited users to create their own profile during first sign-in
      // (role must be 'admin' or 'master_admin' — validated against invite in app code)
      allow create: if isAuth() && request.auth.uid == userId
        && (request.resource.data.role == 'admin' || request.resource.data.role == 'master_admin');

      // Nobody can delete user documents through the client (use Admin SDK only)
      allow delete: if false;
    }

    // ── Franchise Locations collection ──────────────────────────────────────
    match /locations/{locationId} {
      // Allow public read access (needed for parent app to list centres)
      allow read: if true;

      // HQ admins (both roles) can read all locations
      // (redundant with above but kept for clarity)
      // allow read: if isAdmin();

      // Franchise partners can read their own location
      allow read: if isFranchisePartner(locationId);

      // Allow authenticated users to read locations matching their email
      // (needed for franchise partner auto-registration on first sign-in)
      allow read: if isAuth() && resource.data.email == request.auth.token.email;

      // Both admin and master_admin can create and update locations
      allow create, update: if isAdmin()
        && request.resource.data.keys().hasAll(['name', 'address', 'phone', 'email', 'createdAt'])
        && request.resource.data.name is string
        && request.resource.data.email is string
        && request.resource.data.phone is string
        && request.resource.data.address is string;

      // Only master_admin can delete locations
      allow delete: if isMasterAdmin();

      // ── Enquiries sub-collection (public lead forms) ───────────────────
      match /enquiries/{enquiryId} {
        // Anyone can create an enquiry (public form — like bookings)
        allow create: if true;

        // HQ admins can read all enquiries
        allow read: if isAdmin();

        // Franchise partners can read enquiries for their location
        allow read: if isFranchisePartner(locationId);

        // HQ admins can update/delete enquiries
        allow update, delete: if isAdmin();

        // Franchise partners can update enquiries for their location (e.g. mark as read)
        allow update: if isFranchisePartner(locationId);
      }

      // ── Tutors sub-collection ────────────────────────────────────────────
      match /tutors/{tutorId} {
        // HQ admins can read all tutors
        allow read: if isAdmin();

        // Franchise partners can read tutors for their location
        allow read: if isFranchisePartner(locationId);

        // Franchise partners can create, update, and delete tutors at their location
        allow create, update, delete: if isFranchisePartner(locationId);

        // HQ admins can manage all tutors
        allow create, update, delete: if isAdmin();
      }
    }

    // ── Availability collection ─────────────────────────────────────────────
    // Each document ID matches a locationId
    match /availability/{locationId} {
      // Allow public read (needed for parent app)
      allow read: if true;

      // Franchise partners can read and write their own availability
      allow read: if isFranchisePartner(locationId);
      allow write: if isFranchisePartner(locationId);

      // HQ admins can write any availability
      allow write: if isAdmin();
    }

    // ── Bookings collection ──────────────────────────────────────────────
    match /bookings/{bookingId} {
      // Anyone can create a booking (public booking form)
      allow create: if true;

      // Allow public read (needed for parent app to load sessions)
      allow read: if true;

      // HQ admins can read all bookings
      // allow read: if isAdmin();

      // Franchise partners can read bookings for their location
      // allow read: if isAuth() && resource.data.locationId == userDoc().locationId;

      // Franchise partners can update bookings for their location
      allow update: if true;

      // Franchise partners can delete sessions at their location
      allow delete: if isAuth() && resource.data.locationId == userDoc().locationId;

      // HQ admins can update/delete any booking
      allow update, delete: if isAdmin();

      // Students subcollection (enrolled students + attendance)
      match /students/{studentId} {
        allow read: if true;
        allow create, update, delete: if true;
      }
    }

    // ── Pricing collection ──────────────────────────────────────────────
    match /pricing/{locationId} {
      allow read: if true;
      allow write: if isAuth();
      allow write: if isAdmin();
    }

    // ── Sales/Memberships collection ──────────────────────────────────────
    match /sales/{saleId} {
      allow read: if true;
      allow create: if true;
      allow update: if true;
      allow delete: if isAdmin();
    }

    // ── Recurrence Rules collection ─────────────────────────────────────────
    // Stores recurring session templates
    match /recurrence_rules/{ruleId} {
      // HQ admins can read all rules
      allow read: if isAdmin();

      // Franchise partners can read rules for their location
      allow read: if isAuth() && resource.data.locationId == userDoc().locationId;

      // Franchise partners can create, update, delete rules at their location
      allow create: if isAuth();
      allow update, delete: if isAuth() && resource.data.locationId == userDoc().locationId;

      // HQ admins can manage all rules
      allow create, update, delete: if isAdmin();
    }

    // ── Settings collection ────────────────────────────────────────────────
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ── Email Templates collection ─────────────────────────────────────────
    match /email_templates/{templateId} {
      // Cloud Functions need read access for sending emails (service account bypasses rules)
      // Master admins can read and write templates
      allow read: if isMasterAdmin();
      allow write: if isMasterAdmin();
    }

    match /push_notifications/{notificationId} {
      allow read: if isMasterAdmin();
      allow write: if isMasterAdmin();
    }

    // ── Services collection ────────────────────────────────────────────────
    match /services/{serviceId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ── Recurrence Rules collection ─────────────────────────────────────────
    match /recurrence_rules/{ruleId} {
      // HQ admins can read all rules
      allow read: if isAdmin();

      // Franchise partners can read rules for their location
      allow read: if isAuth() && resource.data.locationId == userDoc().locationId;

      // Franchise partners can create, update, and delete rules at their location
      allow create: if isAuth();
      allow update, delete: if isAuth() && resource.data.locationId == userDoc().locationId;

      // HQ admins can manage all rules
      allow update, delete: if isAdmin();
    }

    // ── Invites collection ────────────────────────────────────────────────
    // Stores pending HQ user invites
    match /invites/{inviteId} {
      // Master admins can read all invites
      allow read: if isMasterAdmin();

      // Allow authenticated users to read invites matching their email (for auto-registration)
      allow read: if isAuth() && resource.data.email == request.auth.token.email;

      // Master admins can create invites
      allow create: if isMasterAdmin();

      // Master admins can update invites (e.g. status changes)
      allow update: if isMasterAdmin();

      // Allow invited users to mark their own invite as accepted during first sign-in
      allow update: if isAuth() && resource.data.email == request.auth.token.email
        && resource.data.status == 'pending';

      // Master admins can delete invites (e.g. revoking pending invites)
      allow delete: if isMasterAdmin();
    }

    // ── Activity Logs collection ────────────────────────────────────────────
    // Stores user activity logs per location (sign-ins, edits, etc.)
    // Also stores HQ-scoped logs (scope: 'hq') for admin actions across all locations.
    match /activity_logs/{logId} {
      // HQ admins can read all logs
      allow read: if isAdmin();

      // Master admins can read all logs (including HQ user logs)
      allow read: if isMasterAdmin();

      // Franchise partners can read logs for their location
      allow read: if isAuth() && resource.data.locationId == userDoc().locationId;

      // Authenticated users can create logs (logging their own actions)
      allow create: if isAuth();

      // Nobody can update or delete logs
      allow update, delete: if false;
    }

    // ── Logs collection (franchise partner activity) ─────────────────────────
    match /logs/{logId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if false;
    }

    // ── Parents collection (parent app accounts) ─────────────────────────
    match /parents/{parentId} {
      // Allow public create (parent app sign-up, no Firebase Auth)
      allow create: if true;

      // Allow public read for own document (parent app uses parentId directly)
      allow read: if true;

      // Allow updates (e.g. adding children, editing profile)
      allow update: if true;

      // HQ admins can read all parents
      allow read: if isAdmin();

      // No public delete
      allow delete: if isAdmin();

      // ── Children sub-collection ───────────────────────────────────────
      match /children/{childId} {
        allow read, create, update: if true;
        allow delete: if isAdmin();
      }
    }

    // ── Transactions collection ───────────────────────────────────────────
    match /transactions/{transactionId} {
      allow read: if true;
      allow create: if true;
      allow update, delete: if isAdmin();
    }

    // ── Deny everything else ────────────────────────────────────────────────
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
