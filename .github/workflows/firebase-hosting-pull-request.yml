# Deploy a preview to Firebase Hosting on pull requests.
# PRs are blocked from deploying until all tests pass.

name: Test & Preview on PR
on: pull_request
permissions:
  checks: write
  contents: read
  pull-requests: write
jobs:
  test_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ── Install dependencies ───────────────────────────────────────
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: cd functions && npm ci

      # ── Install Firebase CLI & Emulators ───────────────────────────
      - run: npm install -g firebase-tools
      - name: Cache Firebase emulators
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}

      # ── Cloud Function unit tests (offline, no emulator needed) ────
      - name: Run Cloud Function unit tests
        run: npm run test:functions

      # ── Firestore rules tests (requires Firestore emulator) ────────
      - name: Start Firestore emulator and run rules tests
        run: |
          firebase emulators:exec \
            --only firestore \
            --project success-tutoring-test \
            "npm run test:rules"

      # ── Playwright E2E tests (requires Auth + Firestore emulators) ─
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Start emulators and run E2E tests
        run: |
          firebase emulators:exec \
            --only auth,firestore \
            --project success-tutoring-test \
            "npm run test:e2e"
        env:
          VITE_USE_EMULATOR: 'true'

      # ── Build the frontend ─────────────────────────────────────────
      - run: npm run build

      # ── Deploy preview to Firebase Hosting ────────────────────────
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_SUCCESS_TUTORING_TEST }}
          projectId: success-tutoring-test
