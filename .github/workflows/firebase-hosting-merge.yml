# Deploy to Firebase on merge to main.
# Deploys: Hosting (frontend), Firestore rules, and Cloud Functions.
# All tests must pass before deployment proceeds.

name: Test & Deploy on merge
on:
  push:
    branches:
      - main
jobs:
  test_and_deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ── Install dependencies ───────────────────────────────────────
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: cd functions && npm ci

      # ── Install Firebase CLI & cache emulators ─────────────────────
      - run: npm install -g firebase-tools
      - name: Cache Firebase emulators
        uses: actions/cache@v4
        with:
          path: ~/.cache/firebase/emulators
          key: firebase-emulators-${{ runner.os }}

      # ── Cloud Function unit tests (offline, no emulator needed) ────
      - name: Run Cloud Function unit tests
        run: npm run test:functions

      # ── Firestore rules tests ──────────────────────────────────────
      - name: Run Firestore rules tests
        run: |
          firebase emulators:exec \
            --only firestore \
            --project success-tutoring-test \
            "npm run test:rules"

      # ── Playwright E2E tests ───────────────────────────────────────
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Run E2E tests against emulators
        run: |
          firebase emulators:exec \
            --only auth,firestore \
            --project success-tutoring-test \
            "npm run test:e2e"
        env:
          VITE_USE_EMULATOR: 'true'

      # ── Unit tests (Vitest) ──────────────────────────────────────────
      - name: Run unit tests
        run: npm run test:unit

      # ── Build the frontend ─────────────────────────────────────────
      # Vite automatically loads .env.production during build
      - run: npm run build

      # ── Deploy Hosting (frontend) ──────────────────────────────────
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_SUCCESS_TUTORING_TEST }}
          channelId: live
          projectId: success-tutoring-test

      # ── Deploy Firestore rules + Cloud Functions ───────────────────
      - name: Authenticate and deploy Firestore rules & Cloud Functions
        run: |
          echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT_SUCCESS_TUTORING_TEST }}' > "$RUNNER_TEMP/gha-creds.json"
          export GOOGLE_APPLICATION_CREDENTIALS="$RUNNER_TEMP/gha-creds.json"
          firebase deploy --only firestore:rules,functions --project success-tutoring-test --non-interactive
          rm -f "$RUNNER_TEMP/gha-creds.json"
